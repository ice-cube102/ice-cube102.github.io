<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오늘의 명언</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        .captcha-container {
            position: relative;
            width: 320px;
            height: 120px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            overflow: hidden;
            background-color: #ffffff;
        }
        .captcha-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 2px;
            user-select: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .line {
            position: absolute;
            height: 2px;
            background-color: rgba(0, 0, 0, 0.2);
            z-index: 5;
        }
        /* Custom styles for background transitions */
        .bg-gray-100 { background-color: #f3f4f6; transition: background-color 1s ease-in-out, background-image 1s ease-in-out; }
        .bg-green-100 { background-color: #d1fae5; transition: background-color 1s ease-in-out, background-image 1s ease-in-out; }
        .bg-blue-100 { background-color: #dbeafe; transition: background-color 1s ease-in-out, background-image 1s ease-in-out; }
        .bg-purple-100 { background-color: #ede9fe; transition: background-color 1s ease-in-out, background-image 1s ease-in-out; }
        .bg-gradient-pink-purple { background-image: linear-gradient(to right, #ff7e5f, #feb47b); transition: background-color 1s ease-in-out, background-image 1s ease-in-out; }
        .bg-gradient-blue-green { background-image: linear-gradient(to right, #13547a, #80d0c7); transition: background-color 1s ease-in-out, background-image 1s ease-in-out; }
        .bg-gradient-red-orange { background-image: linear-gradient(to right, #e53935, #e35d5b); transition: background-color 1s ease-in-out, background-image 1s ease-in-out; }
        .bg-gradient-cyan-blue { background-image: linear-gradient(to right, #00BCD4, #2196F3); transition: background-color 1s ease-in-out, background-image 1s ease-in-out; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100 transition-colors duration-500" id="main-body">
    <div class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm">
        <h1 class="text-2xl font-semibold text-center mb-6">오늘의 명언</h1>
        <p class="text-xs text-gray-400 text-center mb-2">사용자 ID: <span id="user-id">...</span></p>
        <p class="text-gray-600 text-center mb-6" id="main-description">아래 이미지의 문자를 대소문자 구분하여 입력하여 오늘의 명언을 받으세요.</p>
        
        <!-- Tabs -->
        <div class="flex justify-center space-x-2 mb-4">
            <button class="tab-button px-4 py-2 text-sm font-medium rounded-md bg-gray-200 hover:bg-gray-300" data-tab="captcha-tab">캡챠</button>
            <button class="tab-button px-4 py-2 text-sm font-medium rounded-md bg-gray-200 hover:bg-gray-300" data-tab="settings-tab">배경 설정</button>
        </div>

        <!-- CAPTCHA Tab Content -->
        <div id="captcha-tab" class="tab-content active">
            <!-- CAPTCHA Section -->
            <div class="flex flex-col items-center mb-6">
                <div id="captcha-image-container" class="captcha-container flex items-center justify-center relative shadow-inner">
                    <!-- Captcha will be generated here by JS -->
                </div>
                <p id="result-message" class="mt-4 text-sm font-medium"></p>
            </div>
            
            <!-- Input and Buttons -->
            <div class="space-y-4">
                <input type="text" id="captcha-input" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="문자를 입력하세요.">
                <button id="check-button" class="w-full bg-blue-500 text-white font-semibold py-2 rounded-md hover:bg-blue-600 transition-colors">확인</button>
            </div>
            
            <!-- New section for the lucky code and quote -->
            <div id="result-info" class="mt-6 p-4 border-t-2 border-dashed border-gray-300 hidden">
                <p class="text-sm text-center text-gray-800 font-bold mb-2">확인되었습니다! 오늘의 행운을 잡으세요!</p>
                <div class="bg-gray-50 p-3 rounded-lg shadow-inner">
                    <p class="text-xs text-gray-500">오늘의 명언:</p>
                    <div class="flex items-center justify-between">
                        <p id="quote-of-the-day" class="text-sm italic text-gray-700 mt-1"></p>
                        <button id="copy-quote-button" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300">복사</button>
                    </div>
                </div>
                <div class="bg-yellow-100 p-3 rounded-lg shadow mt-3">
                    <p class="text-xs text-yellow-700">오늘의 행운의 코드:</p>
                    <div class="flex items-center justify-between">
                        <p id="lucky-code" class="text-lg font-bold text-yellow-900 mt-1"></p>
                        <button id="copy-lucky-code-button" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300">복사</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Background Settings Tab Content -->
        <div id="settings-tab" class="tab-content">
            <div class="space-y-4">
                <h2 class="text-xl font-semibold mb-2 text-center">배경 설정</h2>
                <p class="text-sm text-gray-600 mb-4 text-center">캡챠를 클리어한 횟수에 따라 배경이 잠금 해제됩니다.</p>
                
                <div class="bg-gray-100 p-4 rounded-md shadow-inner">
                    <p class="font-bold text-center">현재 클리어 횟수: <span id="clear-count-display" class="font-bold text-blue-600">0</span></p>
                </div>

                <div class="bg-gray-50 p-4 rounded-md shadow-inner">
                    <h3 class="font-semibold mb-2">변경 조건</h3>
                    <ul class="text-sm text-gray-700 space-y-2">
                        <li class="flex justify-between items-center">
                            <span><span class="font-bold text-gray-600">0회:</span> 기본 배경</span>
                            <button data-bg="bg-gray-100" class="equip-button text-sm px-3 py-1 rounded-md bg-gray-300 text-gray-700 font-medium opacity-50 cursor-not-allowed">장착</button>
                        </li>
                        <li class="flex justify-between items-center">
                            <span><span class="font-bold text-green-600">1회:</span> 연한 초록색 배경</span>
                            <button data-bg="bg-green-100" class="equip-button text-sm px-3 py-1 rounded-md bg-gray-300 text-gray-700 font-medium opacity-50 cursor-not-allowed" disabled>장착</button>
                        </li>
                        <li class="flex justify-between items-center">
                            <span><span class="font-bold text-blue-600">3회:</span> 연한 파란색 배경</span>
                            <button data-bg="bg-blue-100" class="equip-button text-sm px-3 py-1 rounded-md bg-gray-300 text-gray-700 font-medium opacity-50 cursor-not-allowed" disabled>장착</button>
                        </li>
                        <li class="flex justify-between items-center">
                            <span><span class="font-bold text-purple-600">5회:</span> 연한 보라색 배경</span>
                            <button data-bg="bg-purple-100" class="equip-button text-sm px-3 py-1 rounded-md bg-gray-300 text-gray-700 font-medium opacity-50 cursor-not-allowed" disabled>장착</button>
                        </li>
                        <li class="flex justify-between items-center">
                            <span><span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-pink-400 to-purple-500">7회 이상:</span> 그라데이션 1</span>
                            <button data-bg="bg-gradient-pink-purple" class="equip-button text-sm px-3 py-1 rounded-md bg-gray-300 text-gray-700 font-medium opacity-50 cursor-not-allowed" disabled>장착</button>
                        </li>
                        <li class="flex justify-between items-center">
                            <span><span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-600 to-green-400">10회 이상:</span> 그라데이션 2</span>
                            <button data-bg="bg-gradient-blue-green" class="equip-button text-sm px-3 py-1 rounded-md bg-gray-300 text-gray-700 font-medium opacity-50 cursor-not-allowed" disabled>장착</button>
                        </li>
                        <li class="flex justify-between items-center">
                            <span><span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-500 to-blue-500">20회 이상:</span> 그라데이션 3</span>
                            <button data-bg="bg-gradient-cyan-blue" class="equip-button text-sm px-3 py-1 rounded-md bg-gray-300 text-gray-700 font-medium opacity-50 cursor-not-allowed" disabled>장착</button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 로깅 활성화 (디버깅용)
        setLogLevel('Debug');

        // Global variables and constants
        const captchaImageContainer = document.getElementById('captcha-image-container');
        const captchaInput = document.getElementById('captcha-input');
        const checkButton = document.getElementById('check-button');
        const resultMessage = document.getElementById('result-message');
        const resultInfo = document.getElementById('result-info');
        const quoteEl = document.getElementById('quote-of-the-day');
        const luckyCodeEl = document.getElementById('lucky-code');
        const mainBody = document.getElementById('main-body');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const clearCountDisplay = document.getElementById('clear-count-display');
        const equipButtons = document.querySelectorAll('.equip-button');
        const copyQuoteButton = document.getElementById('copy-quote-button');
        const copyLuckyCodeButton = document.getElementById('copy-lucky-code-button');
        const userIdEl = document.getElementById('user-id');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : undefined;
        
        let app, auth, db, userId, userDocRef;
        let correctCaptcha = '';
        let isTodayCleared = false;
        let isFirebaseAvailable = false;
        let localClearCount = 0;
        let localSelectedBackground = 'bg-gray-100';

        const quotes = [
            "시작이 반이다.",
            "하루를 충실하게 살면 한 달이 즐겁고, 한 달을 충실하게 살면 일 년이 즐겁고, 일 년을 충실하게 살면 평생이 즐겁다.",
            "성공은 넘어지는 횟수가 아니라 다시 일어서는 횟수다.",
            "포기하지 않는다면 아무것도 끝나지 않는다.",
            "가장 늦었다고 생각했을 때가 가장 빠른 시작이다.",
            "인생은 용기다.",
            "위대한 정신을 가진 사람들은 목표를 가지고 있고, 그렇지 않은 사람들은 소원을 가지고 있다.",
            "배움은 깨어 있는 영혼의 즐거움이다.",
            "행복이란 무엇인가를 열심히 사랑하는 데 있다.",
            "미래는 현재 우리가 하는 일에 달려 있다.",
            "고난의 시기에 동요하지 않는 것이 진정 위대한 인물이다.",
            "가장 큰 위험은 위험 없는 삶이다.",
            "행복의 문이 하나 닫히면 다른 문이 열린다.",
            "자신을 믿어라. 그러면 어떻게 해야 할지 알게 될 것이다.",
            "태양을 바라보라. 그러면 그림자를 볼 수 없다.",
            "길이 막히면 다른 길을 찾아라.",
            "오늘 할 수 있는 일에 최선을 다하라. 내일은 그것을 완성할 시간이 없으므로.",
            "인생은 자전거를 타는 것과 같다. 균형을 잡으려면 계속 움직여야 한다.",
            "성공의 비결은 평생 동안 계속 배우는 것이다.",
            "용기란 두려움을 느끼지 않는 것이 아니라, 두려움에 맞서는 것이다.",
            "모든 일에는 때가 있고, 모든 소망을 이루는 데는 시간이 있다.",
            "우리가 무엇을 생각하든 우리는 그 자체이다.",
            "가장 어두운 밤에도 별은 빛난다.",
            "인내하는 마음은 모든 것을 이겨낼 수 있다.",
            "변화만이 영원한 것이다.",
            "강한 사람이 이기는 것이 아니라, 이기는 사람이 강한 것이다.",
            "행복은 준비된 마음의 것이다.",
            "최고의 복수는 성공이다.",
            "길이 아닌 곳은 길이 없고, 길이 있는 곳은 길이 아니다.",
            "말할 수 없는 고통을 견디는 것이 곧 용기다.",
            "시련은 있어도 실패는 없다.",
            "사람은 무엇을 배우든 그것을 믿게 된다.",
            "인생은 우리에게 가르쳐 주는 스승이다.",
            "사랑은 희생과 용기로부터 나온다."
        ];

        // Functions
        function generateCaptcha() {
            // 혼동하기 쉬운 문자와 숫자를 제거한 문자열
            const characters = 'ABCDEFGHJLMNQRSTVWZabcfghjmnqrstvwz123456789';
            let captcha = '';
            for (let i = 0; i < 6; i++) {
                captcha += characters.charAt(Math.floor(Math.random() * characters.length));
            }
            return captcha;
        }

        function generateRandomColor() {
            const r = Math.floor(Math.random() * 256);
            const g = Math.floor(Math.random() * 256);
            const b = Math.floor(Math.random() * 256);
            return `rgb(${r}, ${g}, ${b})`;
        }

        function renderCaptcha(text) {
            captchaImageContainer.innerHTML = '';
            
            for (let i = 0; i < 3; i++) {
                const line = document.createElement('div');
                line.className = 'line';
                line.style.top = `${Math.random() * 100}%`;
                line.style.left = `0`;
                line.style.width = `100%`;
                line.style.transform = `rotate(${Math.random() * 10 - 5}deg)`;
                line.style.backgroundColor = generateRandomColor();
                line.style.opacity = '0.5';
                captchaImageContainer.appendChild(line);
            }
            
            text.split('').forEach((char, index) => {
                const span = document.createElement('span');
                span.textContent = char;
                span.className = 'captcha-text';
                span.style.top = `${50 + (Math.random() * 20 - 10)}%`;
                span.style.left = `${10 + (index * 15) + (Math.random() * 5 - 2.5)}%`;
                span.style.transform = `rotate(${Math.random() * 30 - 15}deg)`;
                span.style.color = generateRandomColor();
                span.style.fontSize = `${2 + (Math.random() * 0.5 - 0.25)}rem`;
                captchaImageContainer.appendChild(span);
            });
        }

        function initCaptcha() {
            correctCaptcha = generateCaptcha();
            renderCaptcha(correctCaptcha);
            captchaInput.value = '';
            resultMessage.textContent = '';
            resultInfo.classList.add('hidden');
            captchaInput.disabled = false;
            checkButton.disabled = false;
        }

        function showClearedState(quote, luckyCode) {
            resultMessage.textContent = '오늘은 이미 명언을 받으셨습니다!';
            resultMessage.className = 'mt-4 text-sm font-semibold text-gray-600';
            resultInfo.classList.remove('hidden');
            quoteEl.textContent = quote;
            luckyCodeEl.textContent = luckyCode;
            captchaInput.disabled = true;
            checkButton.disabled = true;
        }

        function _applyVisualBackground(className) {
            mainBody.className = `flex items-center justify-center min-h-screen transition-colors duration-500 ${className}`;
        }
        
        function checkUnlockedBackgrounds(count, selectedBg) {
            const conditions = {
                'bg-gray-100': 0,
                'bg-green-100': 1,
                'bg-blue-100': 3,
                'bg-purple-100': 5,
                'bg-gradient-pink-purple': 7,
                'bg-gradient-blue-green': 10,
                'bg-gradient-cyan-blue': 20
            };

            equipButtons.forEach(button => {
                const bgClass = button.dataset.bg;
                if (isFirebaseAvailable && count >= conditions[bgClass]) {
                    button.disabled = false;
                    button.classList.remove('bg-gray-300', 'text-gray-700', 'opacity-50', 'cursor-not-allowed');
                    button.classList.add('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                } else {
                    button.disabled = true;
                    button.classList.add('bg-gray-300', 'text-gray-700', 'opacity-50', 'cursor-not-allowed');
                    button.classList.remove('bg-blue-500', 'text-white', 'hover:bg-blue-600');
                }
            });

            _applyVisualBackground(selectedBg);
        }
        
        function showTempMessage(message) {
            const messageContainer = document.createElement('div');
            messageContainer.textContent = message;
            messageContainer.className = 'fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg opacity-0 transition-opacity duration-300';
            document.body.appendChild(messageContainer);

            setTimeout(() => {
                messageContainer.style.opacity = '1';
            }, 10);

            setTimeout(() => {
                messageContainer.style.opacity = '0';
                setTimeout(() => {
                    messageContainer.remove();
                }, 300);
            }, 2000);
        }

        async function checkCaptcha() {
            const userInput = captchaInput.value;
            if (userInput === correctCaptcha) {
                resultMessage.textContent = '확인되었습니다!';
                resultMessage.className = 'mt-4 text-sm font-semibold text-green-600';
                
                const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
                const now = new Date();
                const year = now.getFullYear();
                const month = now.getMonth() + 1;
                const day = now.getDate();
                const luckyCode = month * day * year;

                if (isFirebaseAvailable) {
                    // Firebase에 연결된 경우: Firestore에 데이터 저장
                    if (!userDocRef) {
                        console.log("Firebase auth is not ready yet. Please try again in a moment.");
                        return;
                    }
                    if (isTodayCleared) {
                        resultMessage.textContent = '오늘은 이미 명언을 받으셨습니다. 내일 다시 시도하세요.';
                        resultMessage.className = 'mt-4 text-sm font-semibold text-red-600';
                        return;
                    }

                    const today = now.toDateString();
                    const docSnap = await getDoc(userDocRef);
                    let currentClearCount = 0;
                    if (docSnap.exists()) {
                        currentClearCount = docSnap.data().clearCount || 0;
                    }
                    currentClearCount++;
                    
                    await setDoc(userDocRef, { 
                        clearCount: currentClearCount, 
                        lastClearDate: today,
                        quoteOfTheDay: randomQuote,
                        luckyCode: luckyCode
                    }, { merge: true });
                } else {
                    // Firebase에 연결되지 않은 경우: 로컬 상태만 업데이트
                    localClearCount++;
                    clearCountDisplay.textContent = localClearCount;
                    checkUnlockedBackgrounds(localClearCount, localSelectedBackground);
                    showClearedState(randomQuote, luckyCode);
                }

            } else {
                resultMessage.textContent = '잘못된 코드입니다. 다시 시도하세요.';
                resultMessage.className = 'mt-4 text-sm font-semibold text-red-600';
                initCaptcha();
            }
        }

        function initLocalMode() {
            console.log("Firebase initialization failed. Running in offline mode.");
            isFirebaseAvailable = false;
            userIdEl.textContent = "오프라인 모드";
            
            // 로컬 모드에서 초기 UI 상태 설정
            initCaptcha();
            clearCountDisplay.textContent = localClearCount;
            checkUnlockedBackgrounds(localClearCount, localSelectedBackground);

            // 이벤트 리스너 재등록
            checkButton.addEventListener('click', checkCaptcha);
            captchaInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    checkCaptcha();
                }
            });
            equipButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const bgClass = button.dataset.bg;
                    localSelectedBackground = bgClass;
                    checkUnlockedBackgrounds(localClearCount, localSelectedBackground);
                });
            });
        }

        async function initFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                isFirebaseAvailable = true;

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdEl.textContent = userId;
                        userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'userProgress', 'progress');
                        
                        checkButton.addEventListener('click', checkCaptcha);
                        
                        captchaInput.addEventListener('keydown', (e) => {
                            if (e.key === 'Enter') {
                                checkCaptcha();
                            }
                        });

                        onSnapshot(userDocRef, (docSnap) => {
                            let data = { clearCount: 0, selectedBackground: 'bg-gray-100', lastClearDate: null, quoteOfTheDay: null, luckyCode: null };
                            if (docSnap.exists()) {
                                data = docSnap.data();
                            }
                            
                            const today = new Date().toDateString();
                            isTodayCleared = (data.lastClearDate === today);

                            if (isTodayCleared) {
                                showClearedState(data.quoteOfTheDay, data.luckyCode);
                            } else {
                                initCaptcha();
                            }

                            const currentClearCount = data.clearCount || 0;
                            const selectedBackground = data.selectedBackground || 'bg-gray-100';
                            clearCountDisplay.textContent = currentClearCount;
                            checkUnlockedBackgrounds(currentClearCount, selectedBackground);
                        });
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                });

                copyQuoteButton.addEventListener('click', () => {
                    const textToCopy = quoteEl.textContent;
                    if (textToCopy) {
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            showTempMessage('명언이 복사되었습니다!');
                        }).catch(err => {
                            const tempInput = document.createElement('textarea');
                            tempInput.value = textToCopy;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            showTempMessage('명언이 복사되었습니다!');
                        });
                    }
                });

                copyLuckyCodeButton.addEventListener('click', () => {
                    const textToCopy = luckyCodeEl.textContent;
                    if (textToCopy) {
                        navigator.clipboard.writeText(textToCopy).then(() => {
                            showTempMessage('행운의 코드가 복사되었습니다!');
                        }).catch(err => {
                            const tempInput = document.createElement('textarea');
                            tempInput.value = textToCopy;
                            document.body.appendChild(tempInput);
                            tempInput.select();
                            document.execCommand('copy');
                            document.body.removeChild(tempInput);
                            showTempMessage('행운의 코드가 복사되었습니다!');
                        });
                    }
                });
                
                tabButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const targetTab = button.dataset.tab;
                        tabContents.forEach(content => {
                            content.classList.remove('active');
                        });
                        document.getElementById(targetTab).classList.add('active');
                    });
                });

                equipButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        const bgClass = button.dataset.bg;
                        if (userDocRef) {
                            setDoc(userDocRef, { selectedBackground: bgClass }, { merge: true }).catch(e => console.error("Error setting background:", e));
                        }
                    });
                });

            } catch (e) {
                console.error("Firebase Initialization Error:", e);
                initLocalMode();
            }
        }

        window.onload = initFirebase;
    </script>
</body>
</html>
