<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오늘의 명언</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease-in-out;
        }
        .captcha-container {
            position: relative;
            width: 320px;
            height: 120px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            overflow: hidden;
            background-color: #ffffff;
        }
        .captcha-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 2px;
            user-select: none;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            z-index: 10;
        }
        .line {
            position: absolute;
            height: 2px;
            background-color: rgba(0, 0, 0, 0.2);
            z-index: 5;
        }

        .quote-enter {
            opacity: 0;
            transform: translateY(20px);
        }
        .quote-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: all 0.5s ease-out;
        }

        #effect-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 20;
        }
    </style>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        window.firebase = {
            initializeApp,
            getAuth,
            signInAnonymously,
            signInWithCustomToken,
            onAuthStateChanged
        };
    </script>
</head>
<body class="flex flex-col md:flex-row items-center justify-center min-h-screen p-4 md:space-x-8 bg-gray-100" id="main-body">
    <canvas id="effect-canvas"></canvas>

    <!-- 전체 앱 컨테이너. 이 부분을 이미지로 저장합니다. -->
    <div id="app-container" class="bg-white p-8 rounded-xl shadow-lg w-full max-w-sm mb-8 md:mb-0 flex-shrink-0">
        <h1 class="text-2xl font-semibold text-center mb-6">오늘의 명언</h1>
        <p class="text-gray-600 text-center mb-6" id="main-description">아래 문장을 정확하게 입력하면 오늘의 명언을 받을 수 있습니다!</p>

        <!-- 난이도 선택 섹션 -->
        <div id="difficulty-section" class="flex justify-center items-center mb-4 space-x-2">
            <span class="text-sm text-gray-700">난이도:</span>
            <button id="difficulty-short" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-200 text-gray-800 transition-colors duration-200 hover:bg-gray-300">짧은</button>
            <button id="difficulty-normal" class="px-3 py-1 text-sm font-medium rounded-full bg-blue-500 text-white transition-colors duration-200 hover:bg-blue-600">보통</button>
            <button id="difficulty-long" class="px-3 py-1 text-sm font-medium rounded-full bg-gray-200 text-gray-800 transition-colors duration-200 hover:bg-gray-300">긴</button>
        </div>
        
        <div id="challenge-section" class="flex flex-col items-center mb-6">
            <div id="typing-sentence-display" class="w-full text-center p-4 border rounded-md bg-gray-50 mb-4"></div>
            <p id="result-message" class="mt-4 text-sm font-medium"></p>
        </div>
        
        <div id="input-section" class="space-y-4">
            <!-- 사용자가 입력하는 텍스트 입력란 -->
            <input type="text" id="captcha-input" class="w-full px-4 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="문장을 입력하세요.">
        </div>

        <div id="result-info" class="mt-6 p-4 border-t-2 border-dashed border-gray-300 hidden">
            <div class="bg-orange-100 p-3 rounded-lg shadow mt-3">
                <p class="text-xs text-orange-700">오늘의 명언:</p>
                <div class="flex items-center justify-between">
                    <p id="quote-of-the-day" class="text-sm italic text-orange-900 mt-1"></p>
                    <button id="copy-quote-button" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300">복사</button>
                </div>
            </div>

            <div class="bg-yellow-100 p-3 rounded-lg shadow mt-3">
                <p class="text-xs text-yellow-700">오늘의 행운의 코드:</p>
                <div class="flex items-center justify-between">
                    <p id="lucky-code" class="text-lg font-bold text-yellow-900 mt-1"></p>
                    <button id="copy-lucky-code-button" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300">복사</button>
                </div>
            </div>
            
            <div class="bg-green-100 p-3 rounded-lg shadow mt-3">
                <p class="text-xs text-green-700">오늘의 운세:</p>
                <div class="flex items-center justify-between">
                    <p id="fortune-of-the-day" class="text-sm text-green-900 mt-1"></p>
                    <button id="copy-fortune-button" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300">복사</button>
                </div>
            </div>

            <div class="bg-blue-100 p-3 rounded-lg shadow mt-3">
                <p class="text-xs text-blue-700">오늘의 목표:</p>
                <div class="flex items-center justify-between">
                    <p id="goal-of-the-day" class="text-sm font-semibold text-blue-900 mt-1"></p>
                    <button id="copy-goal-button" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300">복사</button>
                </div>
            </div>
            
            <div class="bg-purple-100 p-3 rounded-lg shadow mt-3">
                <p class="text-xs text-purple-700">오늘의 조언:</p>
                <div class="flex items-center justify-between">
                    <p id="advice-of-the-day" class="text-sm font-semibold text-purple-900 mt-1"></p>
                    <button id="copy-advice-button" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300">복사</button>
                </div>
            </div>
            
            <div class="bg-lime-100 p-3 rounded-lg shadow mt-3">
                <p class="text-xs text-lime-700">오늘의 추천 음식:</p>
                <div class="flex items-center justify-between">
                    <p id="food-of-the-day" class="text-sm text-lime-900 font-semibold mt-1"></p>
                    <button id="copy-food-button" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300">복사</button>
                </div>
            </div>

            <div id="color-section" class="bg-gray-100 p-3 rounded-lg shadow mt-3">
                <p class="text-xs text-gray-700">오늘의 색깔:</p>
                <div class="flex items-center justify-between">
                    <p id="color-of-the-day" class="text-sm text-gray-900 font-semibold mt-1"></p>
                    <button id="copy-color-button" class="px-2 py-1 bg-gray-200 text-gray-700 rounded-md text-xs hover:bg-gray-300">복사</button>
                </div>
            </div>

            <!-- 최종 타자 속도 섹션 -->
            <div id="final-wpm-section" class="bg-indigo-900 p-3 rounded-lg shadow mt-3">
                <p class="text-xs text-indigo-100">오늘의 타자 속도:</p>
                <div class="flex items-center justify-between">
                    <p id="final-wpm-display" class="text-sm text-white font-semibold mt-1"></p>
                    <button id="copy-wpm-button" class="px-2 py-1 bg-indigo-700 text-indigo-100 rounded-md text-xs hover:bg-indigo-600">복사</button>
                </div>
            </div>

        </div>
        <!-- 이미지 저장시 숨길 버튼들 -->
        <div id="buttons-to-hide">
            <button id="save-as-image-button" class="w-full mt-2 bg-purple-500 text-white font-semibold py-2 rounded-md hover:bg-purple-600 transition-colors">이미지로 저장</button>
        </div>
    </div>
    
    <script type="module">
        let app;
        let auth;
        let userId;

        const typingSentenceDisplay = document.getElementById('typing-sentence-display');
        const captchaInput = document.getElementById('captcha-input');
        const resultMessage = document.getElementById('result-message');
        const resultInfo = document.getElementById('result-info');
        const goalEl = document.getElementById('goal-of-the-day');
        const quoteEl = document.getElementById('quote-of-the-day');
        const fortuneEl = document.getElementById('fortune-of-the-day');
        const foodEl = document.getElementById('food-of-the-day');
        const adviceEl = document.getElementById('advice-of-the-day');
        const colorSection = document.getElementById('color-section');
        const colorEl = document.getElementById('color-of-the-day');
        const luckyCodeEl = document.getElementById('lucky-code');
        const mainBody = document.getElementById('main-body');
        const appContainer = document.getElementById('app-container');
        const copyGoalButton = document.getElementById('copy-goal-button');
        const copyQuoteButton = document.getElementById('copy-quote-button');
        const copyFortuneButton = document.getElementById('copy-fortune-button');
        const copyFoodButton = document.getElementById('copy-food-button');
        const copyAdviceButton = document.getElementById('copy-advice-button');
        const copyColorButton = document.getElementById('copy-color-button');
        const copyLuckyCodeButton = document.getElementById('copy-lucky-code-button');
        const saveAsImageButton = document.getElementById('save-as-image-button');
        const effectCanvas = document.getElementById('effect-canvas');
        const ctx = effectCanvas.getContext('2d');
        const challengeSection = document.getElementById('challenge-section');
        const inputSection = document.getElementById('input-section');
        const buttonsToHide = document.getElementById('buttons-to-hide');
        const mainDescription = document.getElementById('main-description');
        const finalWpmDisplay = document.getElementById('final-wpm-display');
        const copyWpmButton = document.getElementById('copy-wpm-button');
        const difficultyButtons = {
            short: document.getElementById('difficulty-short'),
            normal: document.getElementById('difficulty-normal'),
            long: document.getElementById('difficulty-long')
        };
        const difficultySection = document.getElementById('difficulty-section');
        const typingSpeedSection = document.getElementById('typing-speed-section');
        
        // 실시간 타자 속도 섹션은 제거합니다.
        if (typingSpeedSection) {
            typingSpeedSection.remove();
        }

        let currentDifficulty = 'normal';
        let requiredTypings = 3;

        const repetitions = {
            short: 5, // 짧은 문장은 5번으로 변경
            normal: 3,
            long: 1
        };

        const baseClasses = 'flex flex-col md:flex-row items-center justify-center min-h-screen p-4 md:space-x-8 transition-colors duration-500';
        const backgroundColors = [
            'bg-gray-100',
            'bg-green-100',
            'bg-blue-100',
            'bg-purple-100',
            'bg-red-400',
            'bg-teal-400',
            'bg-gradient-to-r from-pink-400 to-purple-500',
            'bg-gradient-to-r from-blue-600 to-green-400',
            'bg-gradient-to-r from-cyan-500 to-blue-500',
            'bg-gradient-to-r from-red-500 to-yellow-500',
            'bg-gradient-to-r from-teal-400 to-indigo-500',
            'bg-gradient-to-r from-orange-400 to-rose-500'
        ];

        // 마침표가 제거된 명언들
        const quotes = [
            "시작이 반이다",
            "인생은 용기다",
            "배움은 깨어 있는 영혼의 즐거움이다",
            "고난의 시기에 동요하지 않는 것이 진정 위대한 인물이다",
            "가장 큰 위험은 위험 없는 삶이다",
            "행복의 문이 하나 닫히면 다른 문이 열린다",
            "자신을 믿어라",
            "태양을 바라보라",
            "길이 막히면 다른 길을 찾아라",
            "변화만이 영원한 것이다",
            "시련은 있어도 실패는 없다",
            "사랑은 삶의 가장 큰 축복이다",
            "자신을 사랑하는 것이 모든 것의 시작이다",
            "오늘을 온전히 살아라",
            "모든 일에는 때가 있다"
        ];
        
        // 마침표가 제거된 운세들
        const fortunes = [
            "오늘은 행운이 당신 편에 있습니다 작은 도전도 두려워하지 마세요",
            "예상치 못한 기회가 찾아올 것입니다 주변을 잘 살펴보세요",
            "오래된 문제의 해결책이 보이기 시작합니다 마음을 여유롭게 가지세요",
            "노력의 결실이 빛을 발하는 하루입니다 스스로를 칭찬해주세요",
            "새로운 인연이 당신을 기다립니다 긍정적인 마음으로 다가가세요",
            "몸과 마음이 편안한 하루가 될 것입니다 휴식을 취하며 재충전하세요",
            "어려움이 사라지고 새로운 길이 열립니다 희망을 잃지 마세요",
            "오늘은 예상치 못한 지출이 생길 수 있으니 조심하세요",
            "잠시 하던 일을 멈추고 자신을 돌아보는 시간이 필요합니다",
            "결정을 내리기 전에 한 번 더 신중하게 생각하는 것이 좋겠습니다",
            "작은 오해가 큰 다툼으로 번질 수 있습니다 말을 조심하세요",
            "기대했던 일이 틀어질 수 있습니다 너무 실망하지 마세요",
            "주변의 달콤한 유혹에 넘어가지 않도록 주의가 필요합니다"
        ];

        // 마침표가 제거된 조언들
        const advices = [
            "잠깐의 휴식 시간을 가지며 커피 한 잔의 여유를 즐겨보세요",
            "오늘 할 일을 미리 정리하고 중요한 일부터 시작하면 하루가 편안합니다",
            "작은 성취라도 스스로를 칭찬해주며 긍정적인 기운을 높여보세요",
            "오랜만에 연락하지 못한 사람에게 먼저 안부를 전해보세요",
            "새로운 장소나 길을 걸으며 일상에 신선함을 더해보세요",
            "몸을 가볍게 움직이는 스트레칭으로 활력을 되찾아보세요",
            "오늘 감사했던 일 한 가지를 떠올리고 기록해보세요",
            "어려운 일이 있다면 혼자 고민하지 말고 주변에 도움을 요청하세요",
            "지나간 일에 연연하기보다 현재에 집중하는 것이 중요합니다",
            "새로운 취미를 시작하며 자신만의 즐거움을 찾아보세요"
        ];

        const goals = {
            morning: [
                "아침 스트레칭으로 몸 깨우기",
                "오늘 할 일 3가지 작성하기",
                "따뜻한 물 한 잔 마시기",
                "햇빛을 보며 5분 걷기",
                "감사한 일 한 가지 생각하기"
            ],
            afternoon: [
                "10분 낮잠 또는 명상하기",
                "잠깐 산책하며 바람 쐬기",
                "책상 정리하기",
                "좋아하는 음악 들으며 집중하기",
                "스트레칭으로 몸의 긴장 풀기"
            ],
            evening: [
                "일과를 되돌아보며 기록하기",
                "내일 할 일 미리 정리하기",
                "가벼운 운동으로 하루 마무리하기",
                "따뜻한 물로 샤워하며 하루의 피로 풀기",
                "좋아하는 책 10분 읽기"
            ]
        };

        // 마침표가 제거된 색깔 설명
        const colors = [
            { name: "파란색", meaning: "마음을 차분하게 가라앉히고 평온함을 가져다줍니다", tailwindClass: "bg-blue-100" },
            { name: "노란색", meaning: "긍정적이고 활기찬 기운을 줍니다 자신감을 가지세요", tailwindClass: "bg-yellow-100" },
            { name: "초록색", meaning: "자연의 안정감처럼 마음의 평화를 선물합니다", tailwindClass: "bg-green-100" },
            { name: "보라색", meaning: "창의력을 높여주고 영감을 불어넣습니다", tailwindClass: "bg-purple-100" },
            { name: "주황색", meaning: "새로운 활력과 에너지를 불어넣는 색입니다", tailwindClass: "bg-orange-100" },
            { name: "흰색", meaning: "새로운 시작을 의미합니다 깨끗한 마음으로 출발하세요", tailwindClass: "bg-gray-100" },
            { name: "분홍색", meaning: "부드러움과 사랑이 필요한 오늘, 당신을 감싸줄 겁니다", tailwindClass: "bg-pink-100" },
            { name: "빨간색", meaning: "강한 열정과 에너지를 상징합니다", tailwindClass: "bg-red-100" },
            { name: "갈색", meaning: "안정감과 편안함을 가져다줍니다", tailwindClass: "bg-amber-100" }
        ];

        // 난이도별 타이핑 챌린지 문장
        const sentencesByDifficulty = {
            short: [
                "나는 행복하다",
                "힘내자",
                "오늘도 좋은 하루",
                "사랑은 힘",
                "포기하지 마",
                "웃자",
                "긍정의 힘",
                "나는 할 수 있다"
            ],
            normal: [
                "행복은 선택이다",
                "마음 가는 대로 가라",
                "성공은 태도에 달렸다",
                "오늘은 어제보다 나은 나",
                "꿈은 현실이 된다",
                "변화는 작은 것에서 시작",
                "노력은 배신하지 않는다",
                "포기하지 마라",
                "인생은 아름다운 여행이다",
                "가장 어두운 밤이 지나면 새벽이 온다",
                "모든 것은 변한다"
            ],
            long: [
                "행복은 사소한 일상 속에서 발견하는 작은 기쁨과 감사하는 마음에서 시작됩니다",
                "가장 큰 영광은 한 번도 실패하지 않는 것이 아니라 실패할 때마다 다시 일어나는 데 있습니다",
                "인생에서 가장 중요한 것은 꿈을 쫓는 용기를 잃지 않는 것입니다",
                "모든 위대한 일은 처음에는 불가능해 보였지만 결국에는 해내는 사람들의 노력으로 완성됩니다",
                "변화의 바람이 불어올 때 어떤 사람은 벽을 쌓고 어떤 사람은 풍차를 만든다"
            ]
        };
        
        // 마침표가 제거된 실패 문구
        const failQuotes = [
            "괜찮아요, 잠시 쉬었다 가세요",
            "성공은 수많은 실패 끝에 찾아옵니다",
            "한 번 더 시도할 용기가 있다면 충분합니다",
            "실패는 성공의 어머니입니다"
        ];

        const breakfastFoods = ["따뜻한 스프와 빵", "시리얼", "과일 스무디와 샌드위치", "에그 스크램블", "죽", "요거트와 견과류"];
        const lunchFoods = ["김치찌개와 따뜻한 밥", "돈까스", "샐러드 파스타", "부대찌개", "초밥", "비빔밥", "냉면"];
        const dinnerFoods = ["삼겹살", "파스타", "소고기 스테이크", "치킨", "피자", "닭갈비", "오리고기"];
        const nightSnackFoods = ["매콤한 떡볶이", "라면", "치즈 스틱", "맥주와 감자칩", "순대", "족발"];

        let challengeSentences = [];
        let currentSentenceIndex = 0;
        let typedCount = 0;
        let particles = [];
        let animationFrameId;
        let currentQuoteData = null;
        let startTime = 0;
        let lastKeyPressTime = 0;
        let keyPressCount = 0;
        let typingSpeedInterval = null;

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function initTypingChallenge() {
            requiredTypings = repetitions[currentDifficulty];
            const sentences = sentencesByDifficulty[currentDifficulty];
            if (!sentences) {
                console.error("Error: Sentences for the selected difficulty are not defined.");
                // Fallback to a default difficulty to prevent the error
                currentDifficulty = 'normal';
                requiredTypings = repetitions[currentDifficulty];
                sentences = sentencesByDifficulty[currentDifficulty];
            }
            // 기존 문장 목록에 더 많은 짧은 문장 추가하여 반복이 겹치지 않도록 함
            const allSentencesForDifficulty = [...sentences];
            if (currentDifficulty === 'short') {
                allSentencesForDifficulty.push(
                    "오늘은 행복한 날",
                    "나는 할 수 있다",
                    "용기를 내자",
                    "내일을 향해",
                    "긍정적으로"
                );
            }
            challengeSentences = shuffleArray(allSentencesForDifficulty).slice(0, requiredTypings);
            currentSentenceIndex = 0;
            typedCount = 0;
            typingSentenceDisplay.textContent = challengeSentences[currentSentenceIndex];
            resultMessage.textContent = `(${typedCount}/${requiredTypings}) 정확히 입력하세요.`;
            captchaInput.value = '';
            resultInfo.classList.add('hidden');
            challengeSection.classList.remove('hidden');
            inputSection.classList.remove('hidden');
            buttonsToHide.classList.add('hidden');
            mainDescription.classList.remove('hidden');
            difficultySection.classList.remove('hidden');
            captchaInput.disabled = false;
            captchaInput.focus();
            
            // 실시간 타자 속도 관련 변수 초기화
            startTime = 0;
            lastKeyPressTime = 0;
            keyPressCount = 0;
            if (typingSpeedInterval) {
                clearInterval(typingSpeedInterval);
            }
        }

        function showTempMessage(message) {
            const messageContainer = document.createElement('div');
            messageContainer.textContent = message;
            messageContainer.className = 'fixed bottom-5 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg opacity-0 transition-opacity duration-300';
            document.body.appendChild(messageContainer);

            setTimeout(() => {
                messageContainer.style.opacity = '1';
            }, 10);

            setTimeout(() => {
                messageContainer.style.opacity = '0';
                setTimeout(() => {
                    messageContainer.remove();
                }, 300);
            }, 2000);
        }

        function getFoodRecommendation() {
            const currentHour = new Date().getHours();
            let foodRecommendation;
            
            if (currentHour >= 7 && currentHour < 12) {
                foodRecommendation = `아침: ${breakfastFoods[Math.floor(Math.random() * breakfastFoods.length)]}`;
            } else if (currentHour >= 12 && currentHour < 18) {
                foodRecommendation = `점심: ${lunchFoods[Math.floor(Math.random() * lunchFoods.length)]}`;
            } else if (currentHour >= 18 && currentHour < 21) {
                foodRecommendation = `저녁: ${dinnerFoods[Math.floor(Math.random() * dinnerFoods.length)]}`;
            } else {
                foodRecommendation = `야식: ${nightSnackFoods[Math.floor(Math.random() * nightSnackFoods.length)]}`;
            }
            return foodRecommendation;
        }

        function getGoalForTime() {
            const currentHour = new Date().getHours();
            if (currentHour >= 5 && currentHour < 12) {
                return goals.morning[Math.floor(Math.random() * goals.morning.length)];
            } else if (currentHour >= 12 && currentHour < 18) {
                return goals.afternoon[Math.floor(Math.random() * goals.afternoon.length)];
            } else {
                return goals.evening[Math.floor(Math.random() * goals.evening.length)];
            }
        }

        function clearChallenge() {
            confetti({
                particleCount: 100,
                spread: 70,
                origin: { y: 0.6 }
            });
            
            if (Math.random() < 0.5) {
                startCloverAnimation();
            } else {
                startBlossomAnimation();
            }

            resultMessage.textContent = '확인되었습니다!';
            resultMessage.className = 'mt-4 text-sm font-semibold text-green-600 hidden';

            const endTime = Date.now();
            const timeTakenSeconds = (endTime - startTime) / 1000;
            const totalCharacters = challengeSentences.join('').length;
            const wpm = (totalCharacters / 5) / (timeTakenSeconds / 60);

            finalWpmDisplay.textContent = `${(wpm * 10).toFixed(0)} 타`;
            
            const randomColor = backgroundColors[Math.floor(Math.random() * backgroundColors.length)];
            mainBody.className = `${baseClasses} ${randomColor}`;
            
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            const randomFortune = fortunes[Math.floor(Math.random() * fortunes.length)];
            const foodRecommendation = getFoodRecommendation();
            const randomAdvice = advices[Math.floor(Math.random() * advices.length)];
            const randomColorObject = colors[Math.floor(Math.random() * colors.length)];
            const randomGoal = getGoalForTime();
            
            const now = new Date();
            const luckyCode = (now.getMonth() + 1) * now.getDate() * now.getFullYear();
            currentQuoteData = {
                goal: randomGoal,
                quote: randomQuote,
                fortune: randomFortune,
                food: foodRecommendation,
                advice: randomAdvice,
                color: randomColorObject,
                luckyCode: luckyCode,
                createdAt: Date.now()
            };
            
            quoteEl.textContent = `${currentQuoteData.quote}`;
            fortuneEl.textContent = currentQuoteData.fortune;
            luckyCodeEl.textContent = luckyCode;
            goalEl.textContent = currentQuoteData.goal;
            adviceEl.textContent = currentQuoteData.advice;
            foodEl.textContent = currentQuoteData.food;
            colorEl.textContent = `${currentQuoteData.color.name} (${currentQuoteData.color.meaning})`;
            colorSection.className = `p-3 rounded-lg shadow mt-3 ${currentQuoteData.color.tailwindClass}`;
            
            resultInfo.classList.remove('hidden');
            challengeSection.classList.add('hidden');
            inputSection.classList.add('hidden');
            buttonsToHide.classList.remove('hidden');
            difficultySection.classList.add('hidden');
            mainDescription.classList.add('hidden');

            captchaInput.disabled = true;
            if (typingSpeedInterval) {
                clearInterval(typingSpeedInterval);
            }
        }

        function createClover() {
            return {
                x: Math.random() * effectCanvas.width,
                y: -10,
                size: Math.random() * 3 + 3,
                speed: Math.random() * 1.5 + 0.5,
                opacity: Math.random() * 0.5 + 0.5,
                rotation: Math.random() * 360,
                rotationSpeed: Math.random() * 1 - 0.5
            };
        }

        function drawClover(clover) {
            ctx.beginPath();
            ctx.fillStyle = `rgba(34, 139, 34, ${clover.opacity})`;
            
            const s = clover.size;
            ctx.save();
            ctx.translate(clover.x, clover.y);
            ctx.rotate(clover.rotation * Math.PI / 180);

            for(let i = 0; i < 4; i++) {
                ctx.moveTo(0, 0);
                ctx.arc(s * Math.cos(i * Math.PI/2), s * Math.sin(i * Math.PI/2), s, 0, 2 * Math.PI);
            }

            ctx.fillRect(-1.5, s, 3, s * 2);
            
            ctx.restore();
            ctx.fill();
        }
        
        function createBlossom() {
            return {
                x: Math.random() * effectCanvas.width,
                y: -10,
                size: Math.random() * 5 + 2,
                speed: Math.random() * 2 + 1,
                opacity: Math.random() * 0.5 + 0.3,
                rotation: Math.random() * 360,
                rotationSpeed: Math.random() * 2 - 1
            };
        }

        function drawBlossom(blossom) {
            ctx.beginPath();
            ctx.fillStyle = `rgba(255, 182, 193, ${blossom.opacity})`;
            
            const scale = blossom.size;
            ctx.save();
            ctx.translate(blossom.x, blossom.y);
            ctx.rotate(blossom.rotation * Math.PI / 180);
            ctx.moveTo(0, 0);
            ctx.bezierCurveTo(scale, -scale, 2 * scale, 0, 0, 2 * scale);
            ctx.bezierCurveTo(-2 * scale, 0, -scale, -scale, 0, 0);
            ctx.restore();
            
            ctx.fill();
        }

        function animateParticles() {
            ctx.clearRect(0, 0, effectCanvas.width, effectCanvas.height);
            
            particles.forEach((particle, index) => {
                particle.y += particle.speed;
                particle.x += Math.sin(particle.y / 100) * 0.5;
                particle.rotation += particle.rotationSpeed;
                
                if (particle.y > effectCanvas.height) {
                    particles[index] = particle.type === 'clover' ? createClover() : createBlossom();
                    particles[index].type = particle.type;
                }
                if (particle.type === 'clover') {
                    drawClover(particle);
                } else {
                    drawBlossom(particle);
                }
            });
            
            animationFrameId = requestAnimationFrame(animateParticles);
        }

        function startCloverAnimation() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            particles = [];
            for (let i = 0; i < 30; i++) {
                const clover = createClover();
                clover.type = 'clover';
                particles.push(clover);
            }
            animateParticles();
        }
        
        function startBlossomAnimation() {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
            }
            particles = [];
            for (let i = 0; i < 50; i++) {
                const blossom = createBlossom();
                blossom.type = 'blossom';
                particles.push(blossom);
            }
            animateParticles();
        }

        window.onload = function() {
            effectCanvas.width = window.innerWidth;
            effectCanvas.height = window.innerHeight;

            window.onresize = () => {
                effectCanvas.width = window.innerWidth;
                effectCanvas.height = window.innerHeight;
            };

            initTypingChallenge();

            // 난이도 버튼 클릭 이벤트 리스너
            difficultyButtons.short.addEventListener('click', () => setDifficulty('short'));
            difficultyButtons.normal.addEventListener('click', () => setDifficulty('normal'));
            difficultyButtons.long.addEventListener('click', () => setDifficulty('long'));

            function setDifficulty(level) {
                // 현재 난이도와 새로 선택된 난이도가 같으면 무시
                if (currentDifficulty === level) return;
                
                // 버튼 스타일 업데이트
                const allButtons = [difficultyButtons.short, difficultyButtons.normal, difficultyButtons.long];
                allButtons.forEach(btn => {
                    btn.classList.remove('bg-blue-500', 'text-white');
                    btn.classList.add('bg-gray-200', 'text-gray-800');
                });
                
                const selectedButton = difficultyButtons[level];
                if (selectedButton) {
                    selectedButton.classList.remove('bg-gray-200', 'text-gray-800');
                    selectedButton.classList.add('bg-blue-500', 'text-white');
                }
                
                currentDifficulty = level;
                initTypingChallenge();
            }

            // 입력 즉시 문장 확인
            captchaInput.addEventListener('input', () => {
                const userInput = captchaInput.value.trim();
                
                // 첫 글자 입력 시 시간 초기화
                if (startTime === 0 && userInput.length > 0) {
                    startTime = Date.now();
                }

                // 개발자 모드: '얼음큐브102' 입력 시 바로 완료
                if (userInput === '얼음큐브102') {
                    clearChallenge();
                    return;
                }

                const correctSentence = challengeSentences[currentSentenceIndex];

                // 입력된 텍스트와 정답 문장이 완전히 일치하는지 확인
                if (userInput === correctSentence) {
                    // 입력창 비활성화하여 추가 입력 방지
                    captchaInput.disabled = true;
                    
                    // 성공 메시지 표시
                    resultMessage.textContent = '확인되었습니다!';
                    resultMessage.className = 'mt-4 text-sm font-semibold text-green-600';
                    
                    // 다음 단계 진행
                    typedCount++;
                    
                    setTimeout(() => {
                        captchaInput.value = '';
                        if (typedCount >= requiredTypings) {
                            clearInterval(typingSpeedInterval);
                            clearChallenge();
                        } else {
                            currentSentenceIndex++;
                            typingSentenceDisplay.textContent = challengeSentences[currentSentenceIndex];
                            resultMessage.textContent = `(${typedCount}/${requiredTypings}) 성공! 다음 문장을 입력하세요.`;
                            // 입력창 다시 활성화
                            captchaInput.disabled = false;
                            captchaInput.focus();
                        }
                    }, 200); // 0.2초 딜레이 추가
                } else if (userInput.length > 0 && !correctSentence.startsWith(userInput)) {
                    // 오타가 있을 경우 메시지 표시
                    resultMessage.textContent = '잘못된 문장입니다. 다시 시도하세요.';
                    resultMessage.className = 'mt-4 text-sm font-semibold text-red-600';
                } else {
                    // 정상적으로 입력 중일 경우
                    resultMessage.textContent = `(${typedCount}/${requiredTypings}) 정확히 입력하세요.`;
                    resultMessage.className = 'mt-4 text-sm font-medium';
                }
            });

            // 붙여넣기 방지
            captchaInput.addEventListener('paste', (e) => {
                e.preventDefault();
            });

            copyGoalButton.addEventListener('click', () => {
                const textToCopy = goalEl.textContent;
                if (textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showTempMessage('오늘의 목표가 복사되었습니다!');
                    }).catch(err => {
                        const tempInput = document.createElement('textarea');
                        tempInput.value = textToCopy;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showTempMessage('오늘의 목표가 복사되었습니다!');
                    });
                }
            });

            copyQuoteButton.addEventListener('click', () => {
                const textToCopy = quoteEl.textContent;
                if (textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showTempMessage('명언이 복사되었습니다!');
                    }).catch(err => {
                        const tempInput = document.createElement('textarea');
                        tempInput.value = textToCopy;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showTempMessage('명언이 복사되었습니다!');
                    });
                }
            });
            
            copyFortuneButton.addEventListener('click', () => {
                const textToCopy = fortuneEl.textContent;
                if (textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showTempMessage('운세가 복사되었습니다!');
                    }).catch(err => {
                        const tempInput = document.createElement('textarea');
                        tempInput.value = textToCopy;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showTempMessage('운세가 복사되었습니다!');
                    });
                }
            });

            copyFoodButton.addEventListener('click', () => {
                const textToCopy = foodEl.textContent;
                if (textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showTempMessage('음식 추천이 복사되었습니다!');
                    }).catch(err => {
                        const tempInput = document.createElement('textarea');
                        tempInput.value = textToCopy;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showTempMessage('음식 추천이 복사되었습니다!');
                    });
                }
            });

            copyAdviceButton.addEventListener('click', () => {
                const textToCopy = adviceEl.textContent;
                if (textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showTempMessage('오늘의 조언이 복사되었습니다!');
                    }).catch(err => {
                        const tempInput = document.createElement('textarea');
                        tempInput.value = textToCopy;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showTempMessage('오늘의 조언이 복사되었습니다!');
                    });
                }
            });

            copyColorButton.addEventListener('click', () => {
                const textToCopy = `${colorEl.textContent}`;
                if (textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showTempMessage('오늘의 색깔이 복사되었습니다!');
                    }).catch(err => {
                        const tempInput = document.createElement('textarea');
                        tempInput.value = textToCopy;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showTempMessage('오늘의 색깔이 복사되었습니다!');
                    });
                }
            });


            copyLuckyCodeButton.addEventListener('click', () => {
                const textToCopy = luckyCodeEl.textContent;
                if (textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showTempMessage('행운의 코드가 복사되었습니다!');
                    }).catch(err => {
                        const tempInput = document.createElement('textarea');
                        tempInput.value = textToCopy;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showTempMessage('행운의 코드가 복사되었습니다!');
                    });
                }
            });

            copyWpmButton.addEventListener('click', () => {
                const textToCopy = finalWpmDisplay.textContent;
                if (textToCopy) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showTempMessage('타자 속도가 복사되었습니다!');
                    }).catch(err => {
                        const tempInput = document.createElement('textarea');
                        tempInput.value = textToCopy;
                        document.body.appendChild(tempInput);
                        tempInput.select();
                        document.execCommand('copy');
                        document.body.removeChild(tempInput);
                        showTempMessage('타자 속도가 복사되었습니다!');
                    });
                }
            });
            
            saveAsImageButton.addEventListener('click', () => {
                // 이미지로 저장할 전체 컨테이너를 선택합니다.
                const elementToCapture = document.getElementById('app-container');
                
                // 캡처 전에 숨길 요소들을 정의합니다.
                const elementsToHide = [
                    document.getElementById('challenge-section'),
                    document.getElementById('input-section'),
                    document.getElementById('buttons-to-hide'),
                    document.getElementById('main-description'),
                    document.getElementById('difficulty-section')
                ];
                // 기존의 실시간 타자 속도 섹션은 이미 제거되었으므로 hidden 목록에 포함하지 않습니다.

                // 버튼들만 보이도록 모든 요소를 숨깁니다.
                elementsToHide.forEach(el => el.classList.add('hidden'));

                html2canvas(elementToCapture, { 
                    backgroundColor: null,
                    useCORS: true
                }).then(canvas => {
                    // 캡처 후 숨겼던 요소들을 다시 보이게 합니다.
                    elementsToHide.forEach(el => el.classList.remove('hidden'));
                    
                    const image = canvas.toDataURL('image/png');
                    const link = document.createElement('a');
                    link.href = image;
                    link.download = '오늘의 명언.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showTempMessage('이미지 파일이 다운로드 되었습니다!');
                });
            });

            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');

                app = firebase.initializeApp(firebaseConfig);
                auth = firebase.getAuth(app);

                firebase.onAuthStateChanged(auth, async (user) => {
                    if (!user) {
                        try {
                            if (typeof __initial_auth_token !== 'undefined') {
                                await firebase.signInWithCustomToken(auth, __initial_auth_token);
                            } else {
                                await firebase.signInAnonymously(auth);
                            }
                        } catch (error) {
                            console.error("Firebase auth error:", error);
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        }
    </script>
</body>
</html>
